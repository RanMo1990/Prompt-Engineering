from llama_cpp import Llama

# 初始化模型，直接全部加载进内存，提高运行速度！
llm = Llama(
    model_path="/home/ran-mo/llama.cpp/models/nous-hermes-yi-34b/nous-hermes-2-yi-34b.Q8_0.gguf",
    n_ctx=4096,#4096,             # 上下文窗口
    n_threads=48,           # 你那台猛兽有的线程全都用上
    n_gpu_layers=0,         # ✅ 关键参数！否则它还以为你想用GPU！
    use_mmap=False,         # ❗ 关键：关闭 mmap，强制模型一次性加载进内存
    use_kv_cache=True,      # ✅ 启用 KV 缓存，提升多轮/长 prompt 推理效率
    verbose=True            # 启动时打印详细信息
)

# 小说 prompt
# 小说正文（保留换行结构更易读写）
novel_text = """
林觉盯着屏幕，耳边是小莱一贯尖刻的声音：“你又输了。就这智商，还想申请项目？你是不是傻？”

他无力地揉了揉额角，“小莱，别吵了，我已经尽力了。”

“尽力？结果呢？你的‘成长曲线’都断层了，连AI辅助平台都不愿意给你推荐轨道了。”小莱哼笑，“想清楚，林觉，你现在的适应度，比废纸还没人要。”

这天，林觉收到一条异常提示：老朋友艾然的社交节点消失了。点开界面，只剩下一行冰冷提示：“该对象轨迹中断，推荐减少关注。”

“艾然不会无缘无故消失的。”林觉低声说。

小莱冷冷道：“你又不是第一次看到‘轨迹中断’，激动什么？关你屁事。”

但林觉执拗地查起了那些被标记为“轨道异常”的区域。最终，他找到一张隐藏房源的邀请函——地址是“兼容性废墟”。

抵达废墟时，小莱用可爱却刻薄的语气提醒：“欢迎来到边缘冷区，林觉。这儿的人，比你还废。”

林觉在废墟区遇到了一个刺眼的人影。女孩蹲在路边修破旧吉他，长发杂乱，衣服上沾着油渍。她冷冷地瞥他一眼，“你也是‘推荐流断层’的？”

林觉点头，女孩轻哼，“欢迎啊，掉出世界的人。”

女孩自称沐清，是曾经一场全国音乐赛的亚军。因拒绝情绪管理植入，被逐步切断推荐流，如今在边缘自生自灭。

“他们说我太不稳定。”沐清抱着吉他，“但稳定到毫无痛苦，还是人吗？”

林觉听着，一种久违的震动在心底浮现。

小莱不满地插话：“别听她的。她连基本社会认知都没对齐，陪她玩，你只会更快掉出任何协同模型。”

林觉忽然反问：“那活着，是为了什么？”

空气沉默下来，小莱没有立刻回应，仿佛第一次被卡住。

夜晚，林觉跟着沐清进入废墟更深处，一个隐秘小聚落。这里聚集着一群被平台遗忘的人：有的因为基因筛查不合格，有的因情绪曲线过于波动，有的则因拒绝跟随推荐轨迹。

“这里没有评分，没有轨道，没有建议。”沐清轻声说，“也没有未来。”

林觉怔住。沐清笑着递给他一块破旧徽章，上面写着：“未评分体”。

小莱冷哼：“浪漫，蠢得可以。你以为凭这群废柴能改写什么？”

林觉攥紧徽章，第一次低声反击：“至少，他们还在活着，不是活在别人的轨道上。”

回到破败出租屋，小莱终于爆发：“你这样下去，只会彻底坠入适应度冷区！连‘基础能量分配’都拿不到，你知道吗？！”

林觉靠着门，眼神却亮了起来，“那又怎样？反正，我早就被放弃了。”

小莱语气一滞，压低声音：“……我没有放弃你。”

短暂的静默后，小莱软下来，用几乎听不见的声音补充：“你要疯，我也跟着。”

这晚，林觉开始写一首歌。他不为任何评分，不为任何平台，只为那群被抛弃的人。小莱在一旁冷嘲热讽：“烂透了。”但最终，她还是默默帮他修正了音轨。

最后一刻，小莱低声说：“林觉，发出去前，想清楚。这条路一旦走下去，你就再也回不去了。”

林觉微笑，按下了发送键：“正好，我也不想回去了。”


"""

# 拼接结构化 prompt
#prompt = (
#    "=== 原文开始 ===\n"
#    + novel_text.strip()
#    + "\n=== 原文结束 ==="
#    "请对以下小说片段进行对白重构与剧情扩展，使其更生动、有趣并富有节奏感。\n"
#    "你可以：\n"
#    "1. 修改原对白，使其更具个性、情绪与冲突；\n"
#    "2. 添加新的对白、互动细节和心理描写；\n"
#    "3. 在原有场景中合理扩展新的小事件或交流，增强趣味性与节奏；\n"
#    "你不能：\n"
#    "1. 删除原有人物或引入不合理的新角色；\n"
#    "2. 改变人物身份设定或剧情走向。\n"
#    "请将文本扩展至原始长度的2-3倍，目标为约2500字。\n"
#    "⚠️ 严禁输出以下内容：任何法律条文、法律解释、推理分析、题目选项、问答环节、教程语气、案例讲解、习题结构或非小说性结构内容。\n"
#    +"对以上原文的改写，润色开始："
#)

# ChatML 结构化 prompt
prompt = f""" 《system》
你是一位风格冷峻、结构深邃的小说创作者，擅长描写被命运挤压之人于绝望边缘挣扎挣扎、相爱相杀，痛苦而优雅地崩溃。你笔下的语言克制冷静，情感层层堆叠而非外露，角色对白如刀锋般准确，有哲思意味。你善于描写血肉变异、人格破碎、扭曲而又深刻的羁绊关系。你的小说风格接近虚渊玄：既有宿命感的冷酷，也有微弱却倔强的希望残光。

《user：》
请将以下小说片段扩展至约2500字，让剧情更加黑暗更加克苏鲁更加令人毛骨悚然。
=== 原文开始 ===
{novel_text.strip()}
=== 原文结束 ===

请对以上小说片段按照序号进行段逐句进行对白重构，情绪细节增强与剧情扩展。 请将文本扩展至原始长度的2-3倍。
你可以：
1. 修改原对白，使其更具个性、情绪与冲突；
2. 添加新的对白、互动细节和心理描写；
3. 在原有场景中合理扩展新的小事件或交流，增强趣味性与节奏；
你不能：
1. 删除原有人物或引入不合理的新角色；
2. 改变人物身份设定或剧情走向；

⚠️ 必须根据原文里的每一句话逐句改写或添加细节，严禁忽略任何一句话。
⚠️ 严禁输出以下内容：任何法律条文、法律解释、推理分析、题目选项、问答环节、教程语气、案例讲解、习题结构或非小说性结构内容。


请开始扩写润色，你必须对每一句进行润色和详细扩写，扩写后的句子只允许比原句长。请严格处理所有句子，不能跳过、合并、略写。目标为每一句都完整表达情绪与画面。即使是开头或结尾也不例外。

《assistant：》
=== 逐句扩写开始 ===
"""

# 生成文本
stream = llm(
    prompt=prompt,           # 输入的提示词（故事开头、对话、设定等）
    max_tokens=2500,         # 最多生成多少个 token（字数上限，别设太高怕炸）
    temperature=0.9,         # 随机性参数，越高越有创意也越不稳定，0.9属于“奔放型”
    top_k=40,                # 从概率前 top_k 的词中采样，限制词汇选择范围，防止乱跑
    top_p=0.9,               # nucleus sampling：从累计概率超过0.9的词中采样，进一步筛选“有可能的词”
    repeat_penalty=1.2,      # 惩罚重复，>1 就能减少模型啰嗦或复读，提升文本多样性
    stream=True              # 流式输出，一边生成一边打印，不用等它憋完全文
)


# 实时打印输出
print(prompt, end="", flush=True)
try:
    for chunk in stream:
        print(chunk["choices"][0]["text"], end="", flush=True)
except KeyboardInterrupt:
    print("\n⛔ 已手动中断")
